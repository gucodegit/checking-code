<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <title>–°–ø–∏—Å–æ–∫ –∑–∞–Ω—è—Ç–∏–π - –ê–ª–≥–æ—Ä–∏—Ç–º–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="nav">
        <a href="index.html">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</a>
        <a href="lessons_list.html" class="active">–°–ø–∏—Å–æ–∫ –∑–∞–Ω—è—Ç–∏–π</a>
    </div>

    <div class="form-container">
        <h2>–°–ø–∏—Å–æ–∫ –∑–∞–Ω—è—Ç–∏–π</h2>
        <h3>–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞: –ê–ª–≥–æ—Ä–∏—Ç–º–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
       
        <div class="stats" id="statsInfo">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>

        <div class="filters">
            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É:</label>
                <select id="groupFilter" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É...</option>
                </select>
            </div>
        </div>
        <table class="lessons-table" id="lessonsTable">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞ –∑–∞–Ω—è—Ç–∏—è</th>
                    <th>–ù–æ–º–µ—Ä –∑–∞–¥–∞–Ω–∏—è</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</th>
                    <th>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
                    <th>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</th>
                </tr>
            </thead>
            <tbody id="lessonsTableBody">
                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </tbody>
        </table>

        <div id="emptyMessage" class="empty-state" style="display: none;">
            <p>–ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã</p>
            <p><small>–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –≥—Ä—É–ø–ø—É –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –∑–∞–Ω—è—Ç–∏—è</small></p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const FIXED_SUBJECT = '–ê–ª–≥–æ—Ä–∏—Ç–º–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ';
        let allLessons = [];
        let filteredLessons = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadGroups();
            loadLessons();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø
        async function loadGroups() {
            try {
                const response = await fetch(`${API_BASE}/groups`);
                if (!response.ok) throw new Error('Network error');
                const groups = await response.json();
                const select = document.getElementById('groupFilter');
                groups.forEach(group => {
                    select.innerHTML += `<option value="${group.group_id}">${group.group_name}</option>`;
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–Ω—è—Ç–∏–π
        async function loadLessons() {
            try {
                const response = await fetch(`${API_BASE}/lessons-detailed`);
                if (!response.ok) throw new Error('Network error');
                allLessons = await response.json();
                updateStats();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–Ω—è—Ç–∏–π:', error);
            }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters() {
            const selectedGroupId = parseInt(document.getElementById('groupFilter').value);
            
            if (!selectedGroupId) {
                filteredLessons = [];
                displayLessons();
                return;
            }

            // –ò–º—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã
            const groupSelect = document.getElementById('groupFilter');
            const selectedGroupName = groupSelect.options[groupSelect.selectedIndex].text;

            // –§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–µ –∏ –ø—Ä–µ–¥–º–µ—Ç—É
            filteredLessons = allLessons.filter(lesson => {
                const matchesGroup = lesson.group_name === selectedGroupName;
                const matchesSubject = lesson.subject_name === FIXED_SUBJECT;
                return matchesGroup && matchesSubject;
            });

            displayLessons();
            updateStats();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π
        function displayLessons() {
            const tbody = document.getElementById('lessonsTableBody');
            const emptyMessage = document.getElementById('emptyMessage');
            const table = document.getElementById('lessonsTable');

            if (filteredLessons.length === 0) {
                tbody.innerHTML = '';
                table.style.display = 'none';
                emptyMessage.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyMessage.style.display = 'none';

            tbody.innerHTML = filteredLessons.map(lesson => {
                const today = new Date();
                const deadline = lesson.assignment_deadline ? new Date(lesson.assignment_deadline) : null;
                const isOverdue = deadline && deadline < today;
                const deadlineClass = isOverdue ? 'deadline-warning' : 'deadline-normal';
                const deadlineText = deadline ? 
                    `<span class="${deadlineClass}">${formatDate(deadline)}</span>` : 
                    '<span style="color: #666;">–ù–µ —É–∫–∞–∑–∞–Ω</span>';

                const description = lesson.assignment_description || 
                    '<span style="color: #666; font-style: italic;">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>';

                const attachment = lesson.attachment_path ? 
                    `<a href="${lesson.attachment_path}" class="attachment-link" target="_blank">üìé –°–∫–∞—á–∞—Ç—å</a>` : 
                    '<span style="color: #666;">‚Äî</span>';

                return `
                    <tr>
                        <td><strong>${formatDate(new Date(lesson.lesson_date))}</strong></td>
                        <td><strong>${lesson.assignment_number}</strong></td>
                        <td class="assignment-description">${description}</td>
                        <td>${deadlineText}</td>
                        <td>${attachment}</td>
                    </tr>
                `;
            }).join('');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            const selectedGroupId = parseInt(document.getElementById('groupFilter').value);
            const statsElement = document.getElementById('statsInfo');
            
            if (!selectedGroupId) {
                statsElement.innerHTML = `<strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong>`;
                return;
            }

            const groupSelect = document.getElementById('groupFilter');
            const selectedGroupName = groupSelect.options[groupSelect.selectedIndex].text;
            const totalLessons = filteredLessons.length;
            statsElement.innerHTML = `
                <strong>–ì—Ä—É–ø–ø–∞:</strong> ${selectedGroupName} | 
                <strong>–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π:</strong> ${totalLessons} 
            `;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(date) {
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('groupFilter').addEventListener('change', applyFilters);
    </script>
</body>
</html>
